name: Generate CVMFS Catalog Visualizations

on:
  workflow_dispatch:  # Manual trigger
  schedule:
    - cron: '0 2 * * 0'  # Weekly on Sunday at 2am UTC

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        repo:
          - alice.cern.ch
          - alice-ocdb.cern.ch
          - amber.cern.ch
          - ams.cern.ch
          - atlas.cern.ch
          - atlas-condb.cern.ch
          - atlas-nightlies.cern.ch
          - atlas-online-nightlies.cern.ch
          - cernvm-prod.cern.ch
          - clicdp.cern.ch
          - cms-bril.cern.ch
          - cms.cern.ch
          - cms-ci.cern.ch
          - cms-griddata.cern.ch
          - cms-ib.cern.ch
          - compass.cern.ch
          - cvmfs-config.cern.ch
          - delphi.cern.ch
          - dphep.cern.ch
          - faser.cern.ch
          - fcc.cern.ch
          - geant4.cern.ch
          - grid.cern.ch
          - ilc.desy.de
          - lhcb.cern.ch
          - lhcb-condb.cern.ch
          - lhcbdev.cern.ch
          - na61.cern.ch
          - na62.cern.ch
          - opal.cern.ch
          - patatrack.cern.ch
          - sft.cern.ch
          - sft-nightlies.cern.ch
          - ship.cern.ch
          - sndlhc.cern.ch
          - sw.hsf.org
          - sw-nightlies.hsf.org
          - unpacked.cern.ch
    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          df -h /

      - name: Checkout cvmfsutils
        uses: actions/checkout@v4
        with:
          repository: chrisburr/python-cvmfsutils
          ref: dev

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install cvmfsutils
        run: pip install -e .

      - name: Restore previous tree cache
        uses: actions/cache@v4
        with:
          path: tree-cache
          key: tree-${{ matrix.repo }}-${{ github.run_id }}
          restore-keys: |
            tree-${{ matrix.repo }}-

      - name: Generate visualization
        continue-on-error: true
        timeout-minutes: 360
        run: |
          ulimit -n 65536
          mkdir -p tree-cache
          catalog_visualizer "http://s1cern-cvmfs.openhtc.io/cvmfs/${{ matrix.repo }}" \
            --output "${{ matrix.repo }}.html" \
            --stop-threshold 1000GB \
            --no-cache \
            --no-browser \
            -j 16 \
            --previous-tree "tree-cache/${{ matrix.repo }}.json" \
            --save-tree "tree-cache/${{ matrix.repo }}.json"

      - name: Record generation timestamp
        if: always()
        run: |
          if [ -f "${{ matrix.repo }}.html" ]; then
            date -u +%Y-%m-%dT%H:%M:%SZ > "${{ matrix.repo }}.timestamp"
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: viz-${{ matrix.repo }}
          path: |
            *.html
            *.timestamp
          if-no-files-found: ignore
          retention-days: 1

      - name: Trigger deploy
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api repos/${{ github.repository }}/dispatches \
            -f event_type=deploy-pages \
            -f "client_payload[run_id]=${{ github.run_id }}"
